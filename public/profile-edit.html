<!DOCTYPE html>
<html lang="en" >
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Quizania - Edit Profile</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = {
      darkMode: 'class',
      theme: {
        extend: {
          animation: {
            fadeIn: 'fadeIn 0.5s ease-in-out',
          },
          keyframes: {
            fadeIn: {
              '0%': { opacity: '0' },
              '100%': { opacity: '1' },
            }
          }
        }
      }
    };
  </script>
  <style>
    body {
      font-family: 'Poppins', sans-serif;
    }
    @media (max-width: 768px) {
      .sidebar {
        flex-direction: row;
        overflow-x: auto;
        white-space: nowrap;
        height: auto;
      }
      .sidebar a {
        flex: 1;
        text-align: center;
        padding: 10px 5px;
      }
    }
	body { font-family: 'Poppins', sans-serif; }
    .sidebar a { display: flex; align-items: center; gap: 0.5rem; }
    .overlay { background: rgba(0, 0, 0, 0.5); }
    @media (max-width: 768px) {
      .sidebar { width: 70%; max-width: 280px; height: 100vh; position: fixed; top: 0; left: -100%; z-index: 40; transition: all 0.3s ease; }
      .sidebar.open { left: 0; }
      .mobile-overlay { display: none; }
      .mobile-overlay.show { display: block; position: fixed; inset: 0; z-index: 30; }
    }
		html body > .skiptranslate {
  display: none !important;
}
body {
  top: 0px !important;
}
#google_translate_element,
.goog-te-banner-frame.skiptranslate,
.goog-te-gadget-icon,
.goog-te-gadget-simple {
  display: none !important;
}
  </style>
</head>
<body class="bg-gray-100 text-gray-900 dark:bg-gray-900 dark:text-white">
  
  
<!-- Mobile Navbar -->
<div class="sm:hidden flex justify-between items-center p-4 bg-blue-900 text-white">
  <button onclick="toggleSidebar()">‚ò∞</button>
  <h1 class="font-bold">Quizania</h1>
</div>

<!-- Sidebar Overlay for Mobile -->
<div id="mobileOverlay" class="mobile-overlay overlay"></div>

<div class="flex min-h-screen">
  <!-- Sidebar -->
  <div id="sidebar" class="sidebar bg-blue-900 text-white flex flex-col px-4 py-4 sm:relative sm:w-60 w-full sm:translate-x-0">
    <div class="flex items-center mb-6 space-x-2">
      <img id="profilePreview" src="" alt="Profile" class="w-10 h-10 rounded-full border-2 border-white cursor-pointer" />
      <span class="text-lg font-bold hidden sm:block">Quizania</span>
      <input type="file" id="profilePhoto" accept="image/*" class="hidden" />
    </div>
    <nav class="space-y-2">
      <a href="dashboard.html">üè† Home</a>
      <a href="profile-edit.html">üë§ Profile</a>
      <a href="msg.html">‚úâÔ∏è Messages</a>
      <a href="play.html">‚ñ∂Ô∏è Play</a>
      <a href="#">ü§ù Refer & Earn</a>
      <a href="#">‚öôÔ∏è Setting</a>
      <a href="#">üìù Feedback</a>
    </nav>
    <button onclick="toggleTheme()" class="mt-4 bg-gray-700 hover:bg-gray-600 px-3 py-1 rounded text-sm">Dark</button>
    <button onclick="logout()" class="mt-2 bg-red-500 hover:bg-red-600 px-3 py-1 rounded text-sm">Logout</button>
  </div>


    <!-- Main Content -->
    <main class="flex-1 p-6 max-w-3xl w-full animate-fadeIn">
      <h1 class="text-3xl font-bold mb-6">Edit Profile</h1>

      <form id="profileForm" class="space-y-6 bg-white dark:bg-gray-800 p-6 rounded-lg shadow-lg">
        <div class="flex flex-col items-center space-y-2">
          <img id="photoPreview" src="" alt="Profile Photo" class="w-24 h-24 rounded-full border-4 border-blue-600 object-cover cursor-pointer" />
          <input type="file" id="photoInput" accept="image/*" class="hidden" />
          <button type="button" id="changePhotoBtn" class="text-blue-600 hover:underline">Change Photo</button>
        </div>

        <div>
          <label for="name" class="block mb-1 font-semibold">Name</label>
          <input type="text" id="name" name="name" class="w-full rounded border px-3 py-2 dark:bg-gray-700 dark:border-gray-600" required />
        </div>

        <div>
          <label for="city" class="block mb-1 font-semibold">City</label>
          <input type="text" id="city" name="city" class="w-full rounded border px-3 py-2 dark:bg-gray-700 dark:border-gray-600" />
        </div>

        <div>
          <label for="state" class="block mb-1 font-semibold">State</label>
          <input type="text" id="state" name="state" class="w-full rounded border px-3 py-2 dark:bg-gray-700 dark:border-gray-600" />
        </div>

        <div>
          <label for="mobile" class="block mb-1 font-semibold">Mobile Number</label>
          <input type="tel" id="mobile" name="mobile" class="w-full rounded border px-3 py-2 dark:bg-gray-700 dark:border-gray-600" pattern="[0-9]{10}" placeholder="10-digit number" />
        </div>

        <button type="submit" class="w-full bg-blue-700 hover:bg-blue-800 text-white font-bold py-3 rounded transition">
          Save Changes
        </button>
<div id="loader" class="flex justify-center items-center mt-4 hidden">
  <svg class="animate-spin h-6 w-6 text-blue-700" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
    <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
    <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8v8z"></path>
  </svg>
</div>

        <div id="formMessage" class="text-center mt-2"></div>
      </form>
    </main>

  </div>
  
  
   
 <div id="google_translate_element" style="display: none;"></div>

<script type="text/javascript">
  function googleTranslateElementInit() {
    new google.translate.TranslateElement({
      pageLanguage: 'en',
      includedLanguages: 'en,hi',
      autoDisplay: false
    }, 'google_translate_element');
  }
</script>
<script src="https://translate.google.com/translate_a/element.js?cb=googleTranslateElementInit"></script>

<script>
  function translatePage(code) {
    const dropdown = document.querySelector("#google_translate_element select");
    if (!dropdown) return;
    dropdown.value = code;
    dropdown.dispatchEvent(new Event("change"));
  }

  window.addEventListener("load", () => {
    const savedLang = localStorage.getItem("quizania_lang");
    if (savedLang) {
      const waitForDropdown = setInterval(() => {
        const sel = document.querySelector("#google_translate_element select");
        if (sel) {
          clearInterval(waitForDropdown);
          translatePage(savedLang);
        }
      }, 500);
    }
  });
</script> 
  

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/11.8.1/firebase-app.js";
  import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/11.8.1/firebase-auth.js";
  import { getFirestore, doc, getDoc, setDoc } from "https://www.gstatic.com/firebasejs/11.8.1/firebase-firestore.js";

  const firebaseConfig = {
    apiKey: "AIzaSyBt_ygYw6AgCcOlQYcMAn3rw6Q325IRyy4",
    authDomain: "quizania-b8292.firebaseapp.com",
    projectId: "quizania-b8292",
    storageBucket: "quizania-b8292.appspot.com",
    messagingSenderId: "94747680142",
    appId: "1:94747680142:web:520ef8559cfe766f0c58df",
    measurementId: "G-YM2LZBJNCY"
  };

  const app = initializeApp(firebaseConfig);
  const auth = getAuth(app);
  const db = getFirestore(app);

  const profilePreview = document.getElementById("profilePreview");
  const photoPreview = document.getElementById("photoPreview");
  const photoInput = document.getElementById("photoInput");
  const changePhotoBtn = document.getElementById("changePhotoBtn");
  const form = document.getElementById("profileForm");
  const formMessage = document.getElementById("formMessage");

  let currentUser = null;

  window.toggleTheme = () => {
    document.documentElement.classList.toggle("dark");
  };

  window.logout = () => {
    signOut(auth).then(() => {
      window.location.href = "login.html";
    });
  };

  changePhotoBtn.addEventListener("click", () => photoInput.click());
  photoPreview.addEventListener("click", () => photoInput.click());

  // Utility: compress image if file size > 1MB, downscale max width or height = 800px
  async function compressImage(file) {
    if (file.size <= 1024 * 1024) {
      return file; // no compression needed
    }
    return new Promise((resolve, reject) => {
      const img = new Image();
      const reader = new FileReader();

      reader.onload = (e) => {
        img.src = e.target.result;
      };

      img.onload = () => {
        const canvas = document.createElement("canvas");
        const maxDimension = 800;
        let width = img.width;
        let height = img.height;

        if (width > height) {
          if (width > maxDimension) {
            height *= maxDimension / width;
            width = maxDimension;
          }
        } else {
          if (height > maxDimension) {
            width *= maxDimension / height;
            height = maxDimension;
          }
        }

        canvas.width = width;
        canvas.height = height;
        const ctx = canvas.getContext("2d");
        ctx.drawImage(img, 0, 0, width, height);

        canvas.toBlob(
          (blob) => {
            if (blob.size > file.size) {
              resolve(file);
            } else {
              resolve(new File([blob], file.name, { type: "image/jpeg" }));
            }
          },
          "image/jpeg",
          0.7
        );
      };

      reader.onerror = (err) => reject(err);
      reader.readAsDataURL(file);
    });
  }

  photoInput.addEventListener("change", async () => {
    const file = photoInput.files[0];
    if (!file) return;

    // Show preview immediately
    const reader = new FileReader();
    reader.onload = (e) => {
      photoPreview.src = e.target.result;
    };
    reader.readAsDataURL(file);
  });

  onAuthStateChanged(auth, async (user) => {
    if (!user) {
      window.location.href = "login.html";
      return;
    }
    currentUser = user;

    const userDocRef = doc(db, "users", user.uid);
    const userDocSnap = await getDoc(userDocRef);

    if (userDocSnap.exists()) {
      const data = userDocSnap.data();
      profilePreview.src = data.profilePhoto || `https://ui-avatars.com/api/?name=${encodeURIComponent(user.email || "User")}`;
      photoPreview.src = data.profilePhoto || profilePreview.src;
      form.name.value = data.name || "";
      form.city.value = data.city || "";
      form.state.value = data.state || "";
      form.mobile.value = data.mobile || "";
    } else {
      await setDoc(userDocRef, {
        name: user.email,
        rechargeWallet: 0,
        winningWallet: 0,
        profilePhoto: "",
        city: "",
        state: "",
        mobile: ""
      });
      profilePreview.src = `https://ui-avatars.com/api/?name=${encodeURIComponent(user.email)}`;
      photoPreview.src = profilePreview.src;
      form.name.value = user.email;
    }
  });

  window.toggleSidebar = function () {
    const sidebar = document.getElementById("sidebar");
    const overlay = document.getElementById("mobileOverlay");
    sidebar.classList.toggle("open");
    overlay.classList.toggle("show");
    overlay.onclick = () => {
      sidebar.classList.remove("open");
      overlay.classList.remove("show");
    };
  };

  // CLOUDINARY CONFIGURATION
const CLOUDINARY_URL = "https://api.cloudinary.com/v1_1/dkzjcmkha/image/upload";
const CLOUDINARY_UPLOAD_PRESET = "Profile photo";

form.addEventListener("submit", async (e) => {
  e.preventDefault();
  formMessage.textContent = "";
  const loader = document.getElementById("loader");
  loader.classList.remove("hidden");

  try {
    const name = form.name.value.trim();
    const city = form.city.value.trim();
    const state = form.state.value.trim();
    const mobile = form.mobile.value.trim();

    let photoUrl = photoPreview.src;

    // Upload to Cloudinary if it's a new image (base64 check)
    if (photoPreview.src.startsWith("data:image")) {
      const compressedFile = await compressImage(photoInput.files[0]);
      const formData = new FormData();
      formData.append("file", compressedFile);
      formData.append("upload_preset", CLOUDINARY_UPLOAD_PRESET);

      const response = await fetch(CLOUDINARY_URL, {
        method: "POST",
        body: formData
      });
      const data = await response.json();
      photoUrl = data.secure_url;
    }

    const userDocRef = doc(db, "users", currentUser.uid);
    await setDoc(userDocRef, {
      name,
      city,
      state,
      mobile,
      profilePhoto: photoUrl
    }, { merge: true });

    formMessage.textContent = "Profile saved successfully!";
    formMessage.className = "text-green-600 text-center mt-2";

    // Hide loader after success
    loader.classList.add("hidden");

    // Redirect after 2 seconds
    setTimeout(() => {
      window.location.href = "dashboard.html";
    }, 2000);

  } catch (err) {
    loader.classList.add("hidden");
    formMessage.textContent = "Something went wrong. Please try again.";
    formMessage.className = "text-red-600 text-center mt-2";
    console.error(err);
  }
});


</script>

</body>
</html>
